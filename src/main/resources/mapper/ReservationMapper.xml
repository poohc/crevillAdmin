<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.crevill.reservation.ReservationMapper">
	
	<select id="selectReservationCount" parameterType="kr.co.crevill.schedule.ScheduleDto" resultType="Integer">
        SELECT COUNT(*)
          FROM RESERVATION A,
               SCHEDULE B
         WHERE A.SCHEDULE_ID = B.SCHEDULE_ID
           <if test="scheduleType != null and scheduleType == 'ALL'.toString()">	
           AND B.SCHEDULE_START BETWEEN DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '000000'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S') 
                                    AND DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '235959'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S')
           </if>                         
		   <if test="scheduleType != null and scheduleType == 'ING'.toString()">
		   AND B.SCHEDULE_END BETWEEN NOW() 
                                  AND DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '235959'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S')                                    	
		   </if>
		   <if test="scheduleType != null and scheduleType == 'END'.toString()">
		   AND B.SCHEDULE_END BETWEEN DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '000000'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S') 
                                  AND NOW()                                    	
		   </if>
    </select>
	
    <select id="selectReservationList" parameterType="kr.co.crevill.schedule.ScheduleDto" resultType="kr.co.crevill.reservation.ReservationVo">
        SELECT A.RESERVATION_ID,
			   CASE WHEN LENGTH(A.CELL_PHONE) = 11 THEN CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,4),'-',SUBSTRING(A.CELL_PHONE,8,4))
            	    ELSE CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,3),'-',SUBSTRING(A.CELL_PHONE,7,4)) END AS CELL_PHONE,
               (SELECT NAME FROM MEMBER_PARENT WHERE CELL_PHONE = A.CELL_PHONE) CUSTOMER_NAME, 	    
			   DATE_FORMAT(A.REG_DATE ,'%Y/%m/%d %H:%i') RESERVATION_SIGN_UP_DATE,
			   DATE_FORMAT(B.SCHEDULE_START,'%Y/%m/%d') RESERVATION_DATE,
			   DATE_FORMAT(B.SCHEDULE_START,'%H:%i') RESERVATION_TIME,
			   (SELECT CASE WHEN GRADE = 'DISPOSABLE' THEN '1회권' ELSE '바우처' END FROM VOUCHER WHERE A.VOUCHER_NO = VOUCHER_NO) VOUCHER_TYPE,
			   (SELECT CODE_VALUE FROM COMMON_CODE WHERE CODE_TYPE = 'RESERVATION_STATUS' AND CODE_KEY = A.STATUS) STATUS_NAME,
               A.VOUCHER_NO,
			   A.SCHEDULE_ID,
			   CONCAT(DATE_FORMAT(B.SCHEDULE_START,'%H:%i'),'~',DATE_FORMAT(B.SCHEDULE_END,'%H:%i')) SCHEDULE_TIME, 
               B.NUMBER_OF_PEOPLE,
               B.TUTORING_NUMBER,
			   A.STATUS,
			   A.REG_ID,
			   DATE_FORMAT(A.REG_DATE, '%Y/%m/%d') REG_DATE,
			   A.UPD_ID,
			   DATE_FORMAT(A.UPD_DATE, '%Y/%m/%d') UPD_DATE
          FROM RESERVATION A,
               SCHEDULE B
         WHERE A.SCHEDULE_ID = B.SCHEDULE_ID
      ORDER BY A.REG_DATE DESC  
         LIMIT #{startPage}, #{recordsPerPage}
    </select>
	
	<select id="selectReservationSearchList" parameterType="kr.co.crevill.schedule.ScheduleDto" resultType="kr.co.crevill.reservation.ReservationVo">
        SELECT A.RESERVATION_ID,
			   CASE WHEN LENGTH(A.CELL_PHONE) = 11 THEN CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,4),'-',SUBSTRING(A.CELL_PHONE,8,4))
            	    ELSE CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,3),'-',SUBSTRING(A.CELL_PHONE,7,4)) END AS CELL_PHONE,
			   A.VOUCHER_NO,
			   A.SCHEDULE_ID,
			   CONCAT(DATE_FORMAT(B.SCHEDULE_START,'%H:%i'),'~',DATE_FORMAT(B.SCHEDULE_END,'%H:%i')) SCHEDULE_TIME, 
               <![CDATA[
               CASE WHEN SCHEDULE_START > NOW() THEN 'BE'
                    WHEN SCHEDULE_START <= NOW() AND SCHEDULE_END > NOW() THEN 'ING'
                    ELSE 'END' END AS PROGRESS,
               ]]>     
               B.NUMBER_OF_PEOPLE,
               B.TUTORING_NUMBER, 
			   A.STATUS,
			   A.REG_ID,
			   DATE_FORMAT(A.REG_DATE, '%Y/%m/%d') REG_DATE,
			   A.UPD_ID,
			   DATE_FORMAT(A.UPD_DATE, '%Y/%m/%d') UPD_DATE,
			   COUNT(*) RESERVATION_CNT,
			   (COUNT(*) / B.NUMBER_OF_PEOPLE) * 100 AS RESERVATION_PER,
			   DATE_FORMAT(B.SCHEDULE_START,'%H%i') SCHEDULE_START
          FROM RESERVATION A,
               SCHEDULE B
         WHERE A.SCHEDULE_ID = B.SCHEDULE_ID
           <if test="scheduleType != null and scheduleType == 'ALL'.toString()">	
           AND B.SCHEDULE_START BETWEEN DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '000000'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S') 
                                    AND DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '235959'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S')
           </if>                         
		   <if test="scheduleType != null and scheduleType == 'ING'.toString()">
		   AND B.SCHEDULE_END BETWEEN NOW() 
                                  AND DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '235959'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S')                                    	
		   </if>
		   <if test="scheduleType != null and scheduleType == 'END'.toString()">
		   AND B.SCHEDULE_END BETWEEN DATE_FORMAT(STR_TO_DATE(CONCAT(#{scheduleStart}, '000000'), '%Y%m%d%H%i%S'),'%Y-%m-%d %H:%i:%S') 
                                  AND NOW()                                    	
		   </if>
      GROUP BY A.SCHEDULE_ID
    </select>
	
	<insert id="insertReservation" parameterType="kr.co.crevill.reservation.ReservationDto">
    	INSERT INTO RESERVATION (
   					       		 CELL_PHONE,
								 VOUCHER_NO,
								 SCHEDULE_ID,
								 STATUS,
								 REG_ID,
								 REG_DATE		
   						        )
				         VALUES (
					  		     #{cellPhone},
								 #{voucherNo},
								 #{scheduleId},
								 #{status},
						         #{regId},
						         NOW()
					   		    )
    </insert>
	
</mapper>