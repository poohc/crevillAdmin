<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.crevill.member.MemberMapper">
	
	<select id="checkExistCellPhone" parameterType="kr.co.crevill.member.MemberDto" resultType="Integer">
        SELECT COUNT(*)
          FROM MEMBER_PARENT
         WHERE CELL_PHONE = #{parentCellPhone}
    </select>
	
	<select id="selectMemberCount" parameterType="kr.co.crevill.member.MemberDto" resultType="Integer">
        SELECT COUNT(*)
          FROM MEMBER_PARENT
    </select>
	
    <select id="selectMemberList" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
        SELECT NAME,
               CASE WHEN LENGTH(CELL_PHONE) = 11 THEN CONCAT(SUBSTRING(CELL_PHONE,1,3),'-',SUBSTRING(CELL_PHONE,4,4),'-',SUBSTRING(CELL_PHONE,8,4))
            	    ELSE CONCAT(SUBSTRING(CELL_PHONE,1,3),'-',SUBSTRING(CELL_PHONE,4,3),'-',SUBSTRING(CELL_PHONE,7,4)) END AS CELL_PHONE,
               EMAIL,
               ADDRESS,
               QR_CODE,
               DATE_FORMAT(REG_DATE, '%Y/%m/%d') REG_DATE,
               CASE WHEN STATUS = 'A' THEN 'Active'
            		ELSE 'Inactive' END AS STATUS
          FROM MEMBER_PARENT
    </select>

    <select id="selectMemberInfo" parameterType="kr.co.crevill.member.MemberDto" resultType="kr.co.crevill.member.MemberVo">
        SELECT A.NAME,
               A.CELL_PHONE,
               A.EMAIL,
               A.ADDRESS,
               B.NAME CHILD_NAME,
               B.BIRTHDAY,
               B.SEX,
               B.LEARNING_LEVEL
          FROM MEMBER_PARENT A,
               MEMBER_CHILDREN B
         WHERE A.CELL_PHONE = B.PARENT_CELL_PHONE
           <if test="name != null and name != ''">
           AND A.NAME = #{name}
           </if>
           <if test="cellPhone != null and cellPhone != ''">
           AND A.CELL_PHONE = #{cellPhone}
           </if>
    </select>

    <insert id="insertMemberParent" parameterType="kr.co.crevill.member.MemberDto">
    	INSERT INTO MEMBER_PARENT (
    								NAME,
    								CELL_PHONE,
    								EMAIL,
    								ADDRESS,
    								QR_CODE,
									REG_DATE,
									REG_ID    								
    							   )
							VALUES (
									#{parentName},
									#{cellPhone},
									#{email},
									#{address},
									QR_SEQ_NEXTVAL(),
									NOW(),
									#{regId}
								   )
    </insert>

	<insert id="insertMemberChildren" parameterType="kr.co.crevill.member.MemberDto">
    	INSERT INTO MEMBER_CHILDREN (
    								PARENT_NAME,
    								PARENT_CELL_PHONE,
    								NAME,
    								BIRTHDAY,
    								SEX,
    								LEARNING_LEVEL
    							   )
							VALUES (
									#{parentName},
									#{cellPhone},
									#{childName},
									#{birthday},
									#{sex},
									#{learningLevel}
								   )
    </insert>
	
</mapper>