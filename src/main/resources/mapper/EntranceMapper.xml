<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.crevill.entrance.EntranceMapper">
	
	<select id="selectEntranceList" parameterType="kr.co.crevill.entrance.EntranceDto" resultType="kr.co.crevill.entrance.EntranceVo">
        SELECT A.RESERVATION_ID,
			   CASE WHEN LENGTH(A.CELL_PHONE) = 11 THEN CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,4),'-',SUBSTRING(A.CELL_PHONE,8,4))
            	    ELSE CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,3),'-',SUBSTRING(A.CELL_PHONE,7,4)) END AS CELL_PHONE,
			   A.VOUCHER_NO,
			   A.SCHEDULE_ID,
			   CONCAT(DATE_FORMAT(B.SCHEDULE_START,'%H:%i'),'~',DATE_FORMAT(B.SCHEDULE_END,'%H:%i')) SCHEDULE_TIME, 
               B.NUMBER_OF_PEOPLE,
               B.TUTORING_NUMBER, 
			   A.STATUS,
			   A.REG_ID,
			   DATE_FORMAT(A.REG_DATE, '%Y/%m/%d') REG_DATE,
			   A.UPD_ID,
			   DATE_FORMAT(A.UPD_DATE, '%Y/%m/%d') UPD_DATE,
			   COUNT(*) RESERVATION_CNT,
			   FORMAT(((COUNT(*) / B.NUMBER_OF_PEOPLE) * 100), 0) AS RESERVATION_PER,
			   DATE_FORMAT(B.SCHEDULE_START,'%H%i') SCHEDULE_START,
			   D.NAME CHILDREN_NAME,
			   E.NAME PLAY_NAME,
			   C.QR_CODE MEMBER_QR_CODE,
			   (SELECT COUNT(*) FROM SCHEDULE_ENTRANCE_MEMBER SEM WHERE SEM.SCHEDULE_ID = A.SCHEDULE_ID AND C.QR_CODE = SEM.MEMBER_QR_CODE) ENTRANCE_COUNT
          FROM RESERVATION A,
               SCHEDULE B,
               MEMBER_PARENT C,
               MEMBER_CHILDREN D,
               PLAY E
         WHERE A.SCHEDULE_ID = B.SCHEDULE_ID
           AND A.CELL_PHONE = C.CELL_PHONE 
           AND C.CELL_PHONE = D.PARENT_CELL_PHONE
           AND B.PLAY_ID = E.PLAY_ID 
           AND DATE_FORMAT(B.SCHEDULE_START,'%Y%m%d%H') = DATE_FORMAT(NOW(),'%Y%m%d%H')
    </select>
	
	<select id="selectEntranceInfo" parameterType="kr.co.crevill.entrance.EntranceDto" resultType="kr.co.crevill.entrance.EntranceVo">
        SELECT A.RESERVATION_ID,
			   CASE WHEN LENGTH(A.CELL_PHONE) = 11 THEN CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,4),'-',SUBSTRING(A.CELL_PHONE,8,4))
            	    ELSE CONCAT(SUBSTRING(A.CELL_PHONE,1,3),'-',SUBSTRING(A.CELL_PHONE,4,3),'-',SUBSTRING(A.CELL_PHONE,7,4)) END AS CELL_PHONE,
			   A.VOUCHER_NO,
			   A.SCHEDULE_ID,
			   CONCAT(DATE_FORMAT(B.SCHEDULE_START,'%H:%i'),'~',DATE_FORMAT(B.SCHEDULE_END,'%H:%i')) SCHEDULE_TIME, 
               B.NUMBER_OF_PEOPLE,
               B.TUTORING_NUMBER, 
			   A.STATUS,
			   A.REG_ID,
			   DATE_FORMAT(A.REG_DATE, '%Y/%m/%d') REG_DATE,
			   A.UPD_ID,
			   DATE_FORMAT(A.UPD_DATE, '%Y/%m/%d') UPD_DATE,
			   COUNT(*) RESERVATION_CNT,
			   FORMAT(((COUNT(*) / B.NUMBER_OF_PEOPLE) * 100), 0) AS RESERVATION_PER,
			   DATE_FORMAT(B.SCHEDULE_START,'%H%i') SCHEDULE_START,
			   D.NAME CHILDREN_NAME,
			   E.NAME PLAY_NAME,
			   C.QR_CODE MEMBER_QR_CODE,
			   E.PLAY_TIME
          FROM RESERVATION A,
               SCHEDULE B,
               MEMBER_PARENT C,
               MEMBER_CHILDREN D,
               PLAY E
         WHERE A.RESERVATION_ID = #{reservationId}
           AND A.SCHEDULE_ID = B.SCHEDULE_ID
           AND A.CELL_PHONE = C.CELL_PHONE 
           AND C.CELL_PHONE = D.PARENT_CELL_PHONE
           AND B.PLAY_ID = E.PLAY_ID
    </select>
	
	<select id="checkVoucher" parameterType="kr.co.crevill.entrance.EntranceDto" resultType="kr.co.crevill.entrance.EntranceVo">
		SELECT <![CDATA[
		       CASE WHEN D.PLAY_TIME <= A.TIME_LEFT_MINUTE THEN 'Y'
	    	        ELSE 'N' END AS VOUCHER_AVAILABLE_YN,
	    	   ]]>     
		       D.PLAY_TIME,
		       A.TIME_LEFT_MINUTE 
		  FROM VOUCHER_USE_VIEW A,
		       RESERVATION B,
		       SCHEDULE C,
		       PLAY D
		 WHERE B.RESERVATION_ID = #{reservationId}
		   AND A.VOUCHER_NO = B.VOUCHER_NO
		   AND B.SCHEDULE_ID = C.SCHEDULE_ID 
		   AND C.PLAY_ID = D.PLAY_ID
	</select>
	
	<insert id="insertScheduleEntranceMember" parameterType="kr.co.crevill.entrance.EntranceDto">
		INSERT INTO SCHEDULE_ENTRANCE_MEMBER(
											 SCHEDULE_ID,
											 MEMBER_QR_CODE,
											 CHILDREN_NAME,
											 REG_ID,
											 REG_DATE
											)
							         VALUES (
							         	     #{scheduleId},
							         	     #{memberQrCode},
							         	     #{childrenName},
							         	     #{regId},
							         	     NOW()		
							         		)				
	</insert>
	
	<insert id="insertVoucherUse" parameterType="kr.co.crevill.entrance.EntranceDto">
		INSERT INTO VOUCHER_USE(
								VOUCHER_NO,
								USE_TIME,
								STATUS,
								SCHEDULE_ID,
								REG_ID,
								REG_DATE
							   )
				        VALUES (
				         	    #{voucherNo},
				         	    #{useTime},
				         	    #{status},
				         	    #{scheduleId},
				         	    #{regId},
				         	    NOW()		
				         	   )				
	</insert>
	
</mapper>